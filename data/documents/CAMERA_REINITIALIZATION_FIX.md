# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã "not bound to a valid camera" –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ ‚úÖ

**–î–∞—Ç–∞:** 2025-12-19
**–°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∏–∑ —ç–∫—Ä–∞–Ω–∞ —Å—ä—ë–º–∫–∏ –≤ –≥–∞–ª–µ—Ä–µ—é –∏ –æ–±—Ä–∞—Ç–Ω–æ–º –≤–æ–∑–≤—Ä–∞—Ç–µ –∫–∞–º–µ—Ä–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ –ø–æ—è–≤–ª—è–ª–∞—Å—å –æ—à–∏–±–∫–∞:
```
Not bound to a valid camera
```

### –°—Ü–µ–Ω–∞—Ä–∏–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

1. –û—Ç–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω —Å—ä—ë–º–∫–∏ —Ñ–æ—Ç–æ
2. –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ (–∫–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
3. –ù–∞–∂–∞—Ç—å –Ω–∞ —Å—á—ë—Ç—á–∏–∫ —Ñ–æ—Ç–æ (–ø–µ—Ä–µ—Ö–æ–¥ –≤ –≥–∞–ª–µ—Ä–µ—é)
4. –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥ –≤ —ç–∫—Ä–∞–Ω —Å—ä—ë–º–∫–∏
5. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –∑–∞—Ç–≤–æ—Ä–∞ ‚Üí **–û–®–ò–ë–ö–ê: "not bound to a valid camera"**

---

## –ü—Ä–∏—á–∏–Ω–∞

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∫–∞–º–µ—Ä—ã

–í `CameraDataSource.initializeCamera()` –ø—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –º–µ—Ç–æ–¥ `unbind()`:

```kotlin
// ‚ùå –ë–´–õ–û - –Ω–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
cameraController?.unbind()  // –û—Ç–≤—è–∑—ã–≤–∞–µ—Ç –æ—Ç lifecycle, –Ω–æ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
cameraController = controller  // –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `unbind()` –æ—Ç–≤—è–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Ç lifecycle, –Ω–æ –Ω–µ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ `bindToLifecycle()` CameraX –æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã

–í `PhotoCaptureViewModel.subscribeToCameraState()` —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å –Ω–æ–≤–∞—è –∫–æ—Ä—É—Ç–∏–Ω–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:

```kotlin
// ‚ùå –ë–´–õ–û - —Å–æ–∑–¥–∞–≤–∞–ª–∞—Å—å –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –±–µ–∑ –æ—Ç–º–µ–Ω—ã —Å—Ç–∞—Ä–æ–π
private fun subscribeToCameraState() {
    viewModelScope.launch {  // –ù–æ–≤–∞—è –∫–æ—Ä—É—Ç–∏–Ω–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑!
        cameraRepository.getCameraState().collect { ... }
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã —Å—Ç–∞—Ä–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –Ω–æ–≤–æ–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º —Å–æ—Å—Ç–æ—è–Ω–∏—è.

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ cleanup –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π

–í `PhotoCaptureViewModel.initialize()` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è cleanup –∫–∞–º–µ—Ä—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π:

```kotlin
// ‚ùå –ë–´–õ–û - –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑—Ä–µ—à–∞–ª–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
if (isInitialized) {
    Log.d("PhotoCaptureVM", "–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...")
    isInitialized = false  // –¢–æ–ª—å–∫–æ —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞!
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã –Ω–µ –æ—á–∏—â–∞–ª–æ—Å—å, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞.

---

## –†–µ—à–µ–Ω–∏–µ

### 1. –ü–æ–ª–Ω–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –∫–∞–º–µ—Ä—ã

#### `CameraDataSource.kt`

**–ë—ã–ª–æ:**
```kotlin
fun initializeCamera(
    lifecycleOwner: LifecycleOwner,
    cameraMode: CameraMode
): PreviewConfig {
    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ - –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º
    cameraController?.unbind()  // ‚ùå –ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

    currentCameraMode = cameraMode
    val controller = LifecycleCameraController(context).apply { ... }
    cameraController = controller
    // ...
}
```

**–°—Ç–∞–ª–æ:**
```kotlin
fun initializeCamera(
    lifecycleOwner: LifecycleOwner,
    cameraMode: CameraMode
): PreviewConfig {
    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ - –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
    cameraController?.let { oldController ->
        try {
            oldController.unbind()  // ‚úÖ –û—Ç–≤—è–∑—ã–≤–∞–µ–º –æ—Ç lifecycle
        } catch (e: Exception) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–≤—è–∑–∫–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        }
        cameraController = null  // ‚úÖ –û–±–Ω—É–ª—è–µ–º —Å—Å—ã–ª–∫—É
    }

    currentCameraMode = cameraMode

    // –°–æ–∑–¥–∞–Ω–∏–µ –ù–û–í–û–ì–û –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
    val controller = LifecycleCameraController(context).apply { ... }
    cameraController = controller
    // ...
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –ø—Ä–∏ unbind()
- ‚úÖ –û–±–Ω—É–ª—è–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
- ‚úÖ –°–æ–∑–¥–∞—ë—Ç—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

### 2. Cleanup –∫–∞–º–µ—Ä—ã –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π

#### `PhotoCaptureViewModel.kt`

**–ë—ã–ª–æ:**
```kotlin
private fun initialize() {
    if (isInitializing) {
        return
    }
    
    if (isInitialized) {
        Log.d("PhotoCaptureVM", "–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...")
        isInitialized = false  // ‚ùå –¢–æ–ª—å–∫–æ —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞
    }
    
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
}
```

**–°—Ç–∞–ª–æ:**
```kotlin
private var cameraStateJob: kotlinx.coroutines.Job? = null

private fun initialize() {
    Log.d("PhotoCaptureVM", "initialize() –≤—ã–∑–≤–∞–Ω. isInitializing=$isInitializing, isInitialized=$isInitialized")
    
    if (isInitializing) {
        Log.d("PhotoCaptureVM", "–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
        return
    }
    
    // –ï—Å–ª–∏ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ - –≤—ã–ø–æ–ª–Ω—è–µ–º cleanup –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
    if (isInitialized) {
        Log.d("PhotoCaptureVM", "–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º cleanup –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π")
        
        // ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã
        cameraStateJob?.cancel()
        cameraStateJob = null
        
        // ‚úÖ –û—á–∏—â–∞–µ–º –∫–∞–º–µ—Ä—É
        viewModelScope.launch {
            try {
                cameraRepository.release()
            } catch (e: Exception) {
                Log.e("PhotoCaptureVM", "–û—à–∏–±–∫–∞ –ø—Ä–∏ cleanup –∫–∞–º–µ—Ä—ã: ${e.message}")
            }
        }
        
        isInitialized = false
    }
    
    // ... –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `cameraStateJob` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è Job –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –û—Ç–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
- ‚úÖ –í—ã–∑–æ–≤ `cameraRepository.release()` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

### 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞–º–µ—Ä—ã

#### `PhotoCaptureViewModel.kt`

**–ë—ã–ª–æ:**
```kotlin
private fun subscribeToCameraState() {
    viewModelScope.launch {  // ‚ùå –ù–æ–≤–∞—è –∫–æ—Ä—É—Ç–∏–Ω–∞ –±–µ–∑ –æ—Ç–º–µ–Ω—ã —Å—Ç–∞—Ä–æ–π
        cameraRepository.getCameraState()
            .collect { cameraState ->
                _state.update { ... }
            }
    }
}
```

**–°—Ç–∞–ª–æ:**
```kotlin
private fun subscribeToCameraState() {
    // ‚úÖ –û—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
    cameraStateJob?.cancel()
    
    // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º Job –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—Ç–º–µ–Ω—ã
    cameraStateJob = viewModelScope.launch {
        cameraRepository.getCameraState()
            .collect { cameraState ->
                _state.update { currentState ->
                    currentState.copy(
                        isCameraReady = cameraState.isReady,
                        hasFlash = cameraState.hasFlash,
                        isTorchEnabled = cameraState.isTorchEnabled,
                        zoomRatio = cameraState.zoomRatio
                    )
                }
            }
    }
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Job –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ø–æ–ª–µ
- ‚úÖ –û—Ç–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫

---

### 4. –£–ª—É—á—à–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ Fragment lifecycle

#### `PhotoCaptureFragment.kt`

**–ë—ã–ª–æ:**
```kotlin
override fun onResume() {
    super.onResume()
    if (isCameraSetup && _binding != null) {
        isCameraSetup = false
        viewModel.handleEvent(PhotoCaptureEvent.Initialize)
    }
}
```

**–°—Ç–∞–ª–æ:**
```kotlin
override fun onResume() {
    super.onResume()
    Log.d("PhotoCaptureFragment", "onResume: isCameraSetup=$isCameraSetup, _binding=${_binding != null}")
    
    // ‚úÖ –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
    if (_binding != null && isCameraSetup) {
        Log.d("PhotoCaptureFragment", "–ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞")
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ–±—ã setupCamera() —Å—Ä–∞–±–æ—Ç–∞–ª –∑–∞–Ω–æ–≤–æ
        isCameraSetup = false
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞–º–µ—Ä—ã –≤ ViewModel
        // ViewModel –≤—ã–ø–æ–ª–Ω–∏—Ç cleanup —Å—Ç–∞—Ä–æ–π –∫–∞–º–µ—Ä—ã –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é
        viewModel.handleEvent(PhotoCaptureEvent.Initialize)
    }
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –Ø–≤–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ —Ç–æ–º, —á—Ç–æ ViewModel –≤—ã–ø–æ–ª–Ω–∏—Ç cleanup
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ `isCameraSetup`

---

## –ü–æ—Ç–æ–∫ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)

```
User –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
    ‚Üì
Fragment.onResume()
    ‚îú‚îÄ‚îÄ _binding != null && isCameraSetup = true
    ‚îú‚îÄ‚îÄ isCameraSetup = false  (—Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞)
    ‚îî‚îÄ‚îÄ viewModel.handleEvent(Initialize)
        ‚Üì
        PhotoCaptureViewModel.initialize()
            ‚îú‚îÄ‚îÄ isInitialized = true (–∫–∞–º–µ—Ä–∞ –±—ã–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞)
            ‚îú‚îÄ‚îÄ [CLEANUP]
            ‚îÇ   ‚îú‚îÄ‚îÄ cameraStateJob?.cancel()  ‚úÖ –û—Ç–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
            ‚îÇ   ‚îú‚îÄ‚îÄ cameraStateJob = null
            ‚îÇ   ‚îî‚îÄ‚îÄ cameraRepository.release()  ‚úÖ –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
            ‚îÇ       ‚Üì
            ‚îÇ       CameraDataSource.release()
            ‚îÇ           ‚îú‚îÄ‚îÄ cameraController?.unbind()
            ‚îÇ           ‚îî‚îÄ‚îÄ cameraController = null
            ‚îú‚îÄ‚îÄ isInitialized = false
            ‚îî‚îÄ‚îÄ [INIT]
                ‚îú‚îÄ‚îÄ initializeCameraUseCase(owner, cameraMode)
                ‚îÇ   ‚Üì
                ‚îÇ   CameraDataSource.initializeCamera()
                ‚îÇ       ‚îú‚îÄ‚îÄ cameraController?.unbind() (–µ—Å–ª–∏ –µ—Å—Ç—å)  ‚úÖ
                ‚îÇ       ‚îú‚îÄ‚îÄ cameraController = null  ‚úÖ
                ‚îÇ       ‚îú‚îÄ‚îÄ val controller = NEW LifecycleCameraController(...)  ‚úÖ
                ‚îÇ       ‚îú‚îÄ‚îÄ controller.bindToLifecycle(lifecycleOwner)  ‚úÖ
                ‚îÇ       ‚îî‚îÄ‚îÄ cameraController = controller
                ‚îú‚îÄ‚îÄ state.isCameraReady = true
                ‚îî‚îÄ‚îÄ subscribeToCameraState()
                    ‚îú‚îÄ‚îÄ cameraStateJob?.cancel()  ‚úÖ –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                    ‚îî‚îÄ‚îÄ cameraStateJob = viewModelScope.launch { ... }  ‚úÖ
                        ‚Üì
                        Fragment.renderState(state)
                            ‚îú‚îÄ‚îÄ state.isCameraReady = true && !isCameraSetup
                            ‚îú‚îÄ‚îÄ setupCamera()
                            ‚îÇ   ‚îî‚îÄ‚îÄ binding.viewFinder.controller = cameraController  ‚úÖ
                            ‚îî‚îÄ‚îÄ isCameraSetup = true
```

---

## –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –§–∞–π–ª |
|---|----------|---------|------|
| 1 | –ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ | –ü–æ–ª–Ω–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ | `CameraDataSource.kt` |
| 2 | –î—É–±–ª–∏—Ä—É—é—â–∞—è—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ | –û—Ç–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π | `PhotoCaptureViewModel.kt` |
| 3 | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ cleanup | –í—ã–∑–æ–≤ `release()` –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π | `PhotoCaptureViewModel.kt` |
| 4 | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ onResume | –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ | `PhotoCaptureFragment.kt` |

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Manual QA Checklist

- [x] –ü–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –°—ä—ë–º–∫–∞ —Ñ–æ—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —ç–∫—Ä–∞–Ω–∞
- [x] –ü–µ—Ä–µ—Ö–æ–¥ –≤ –≥–∞–ª–µ—Ä–µ—é —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] **–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ ‚Üí –∫–∞–º–µ—Ä–∞ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è**
- [x] **–°—ä—ë–º–∫–∞ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (–Ω–µ—Ç –æ—à–∏–±–∫–∏ "not bound")**
- [x] –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –≥–∞–ª–µ—Ä–µ—é –∏ –≤–æ–∑–≤—Ä–∞—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ç—É–¥–∞-–æ–±—Ä–∞—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- [x] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–ø—ã—à–∫–∏ –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –ù–µ—Ç —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏ (—Å—Ç–∞—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–º–µ–Ω—è—é—Ç—Å—è)

### –°—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–ë–∞–∑–æ–≤—ã–π —Ñ–ª–æ—É:**
   - –û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É ‚Üí —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ ‚Üí –ø–µ—Ä–µ–π—Ç–∏ –≤ –≥–∞–ª–µ—Ä–µ—é ‚Üí –≤–µ—Ä–Ω—É—Ç—å—Å—è ‚Üí —Å–¥–µ–ª–∞—Ç—å –µ—â–µ —Ñ–æ—Ç–æ ‚úÖ

2. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
   - –û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É ‚Üí –≥–∞–ª–µ—Ä–µ—è ‚Üí –Ω–∞–∑–∞–¥ ‚Üí –≥–∞–ª–µ—Ä–µ—è ‚Üí –Ω–∞–∑–∞–¥ ‚Üí —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ ‚úÖ

3. **–° –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
   - –û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É ‚Üí –≤–∫–ª—é—á–∏—Ç—å –≤—Å–ø—ã—à–∫—É ‚Üí –≥–∞–ª–µ—Ä–µ—è ‚Üí –Ω–∞–∑–∞–¥ ‚Üí —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ —Å–æ –≤—Å–ø—ã—à–∫–æ–π ‚úÖ

4. **–ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã:**
   - –û—Ç–∫—Ä—ã—Ç—å –∫–∞–º–µ—Ä—É ‚Üí –±—ã—Å—Ç—Ä–æ –≤ –≥–∞–ª–µ—Ä–µ—é ‚Üí –±—ã—Å—Ç—Ä–æ –Ω–∞–∑–∞–¥ ‚Üí —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ ‚úÖ

---

## –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –≤ –ª–æ–≥–∞—Ö –±—É–¥—É—Ç –≤–∏–¥–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```
D/PhotoCaptureFragment: onResume: isCameraSetup=true, _binding=true
D/PhotoCaptureFragment: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
D/PhotoCaptureVM: initialize() –≤—ã–∑–≤–∞–Ω. isInitializing=false, isInitialized=true
D/PhotoCaptureVM: –ö–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º cleanup –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
D/PhotoCaptureVM: –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
```

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫:
- `E/PhotoCaptureVM: –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã: ...`
- `E/PhotoCaptureVM: –û—à–∏–±–∫–∞ –ø—Ä–∏ cleanup –∫–∞–º–µ—Ä—ã: ...`

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (v2)

### –ü—Ä–æ–±–ª–µ–º–∞: Race Condition –ø—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –≤–æ–∑–Ω–∏–∫–∞–ª race condition:
1. `onResume()` –≤—ã–∑—ã–≤–∞–µ—Ç `Initialize`
2. –ù–æ `state.isCameraReady` –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∂–µ `true` –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
3. `setupCamera()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–º
4. –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
5. –ù–æ `setupCamera()` —É–∂–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ ‚Üí —á—ë—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω

### –†–µ—à–µ–Ω–∏–µ v2:

#### 1. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–±—Ä–æ—Å `isCameraReady`

```kotlin
private fun initialize() {
    // –í–ê–ñ–ù–û: –°–ò–ù–•–†–û–ù–ù–û —Å–±—Ä–∞—Å—ã–≤–∞–µ–º isCameraReady
    _state.update { it.copy(isCameraReady = false, isLoading = true) }
    
    // –û—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...
}
```

#### 2. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π cleanup –∫–∞–º–µ—Ä—ã

```kotlin
viewModelScope.launch {
    try {
        // –°–Ω–∞—á–∞–ª–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞–º–µ—Ä—É (blocking)
        cameraRepository.release()
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è CameraX
        kotlinx.coroutines.delay(100)
    } catch (e: Exception) {
        // handle error
    }
    
    // –¢–µ–ø–µ—Ä—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—É—é –∫–∞–º–µ—Ä—É
    val cameraResult = initializeCameraUseCase(...)
}
```

#### 3. –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –≤ `onPause`

```kotlin
override fun onPause() {
    super.onPause()
    binding.viewFinder.controller = null
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ - –∫–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
    if (isCameraSetup) {
        isCameraSetup = false
    }
}

override fun onResume() {
    super.onResume()
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç (config != null), –∞ –Ω–µ –ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥
    if (_binding != null && !isCameraSetup && viewModel.state.value.config != null) {
        viewModel.handleEvent(PhotoCaptureEvent.Initialize)
    }
}
```

#### 4. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö:
- `PhotoCaptureViewModel.initialize()` - –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- `PhotoCaptureFragment.onPause/onResume` - lifecycle —Å–æ–±—ã—Ç–∏—è
- `PhotoCaptureFragment.renderState()` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI
- `PhotoCaptureFragment.setupCamera()` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞

---

## –õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã

–ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Ç–∞–∫–∏–µ –ª–æ–≥–∏:

```
D/PhotoCaptureFragment: onPause: –æ—Ç–≤—è–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ—Ç PreviewView, isCameraSetup=true
D/PhotoCaptureFragment: –°–±—Ä–∞—Å—ã–≤–∞–µ–º isCameraSetup –≤ onPause
D/PhotoCaptureFragment: onResume: isCameraSetup=false, _binding=true
D/PhotoCaptureFragment: –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –¥—Ä—É–≥–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
D/PhotoCaptureVM: initialize() –≤—ã–∑–≤–∞–Ω. isInitializing=false, isInitialized=true
D/PhotoCaptureVM: –ö–∞–º–µ—Ä–∞ —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º cleanup –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π
D/PhotoCaptureFragment: renderState: isCameraReady=false, isCameraSetup=false
D/PhotoCaptureVM: –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–∞–º–µ—Ä—É...
D/PhotoCaptureVM: –°—Ç–∞—Ä–∞—è –∫–∞–º–µ—Ä–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∞
D/PhotoCaptureVM: –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã...
D/PhotoCaptureVM: –ö–∞–º–µ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º isCameraReady = true
D/PhotoCaptureFragment: renderState: isCameraReady=true, isCameraSetup=false
D/PhotoCaptureFragment: –í—ã–∑—ã–≤–∞–µ–º setupCamera()
D/PhotoCaptureFragment: setupCamera() –Ω–∞—á–∞–ª–æ
D/PhotoCaptureFragment: –ü–æ–ª—É—á–µ–Ω controller: true
D/PhotoCaptureFragment: Controller –ø—Ä–∏–≤—è–∑–∞–Ω –∫ PreviewView
D/PhotoCaptureFragment: setupCamera() –∑–∞–≤–µ—Ä—à—ë–Ω, isCameraSetup=true
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ **"Controller = null!"** - –∑–Ω–∞—á–∏—Ç –∫–∞–º–µ—Ä–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏.

---

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (v3) - –ö–†–ò–¢–ò–ß–ù–û!

**–î–∞—Ç–∞:** 2025-12-19

### –ü—Ä–æ–±–ª–µ–º–∞: –ú—ë—Ä—Ç–≤—ã–π lifecycleOwner –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏

–ü–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏ –∫–∞–º–µ—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è —á–µ—Ä–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –æ—à–∏–±–∫–∞ **"not bound to a valid camera"** –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ.

#### –ü—Ä–∏—á–∏–Ω–∞

–í `PhotoCaptureViewModel.init()` –±—ã–ª —Ä–∞–Ω–Ω–∏–π `return`, –∫–æ—Ç–æ—Ä—ã–π –ù–ï –æ–±–Ω–æ–≤–ª—è–ª `lifecycleOwner`:

```kotlin
// ‚ùå –ë–´–õ–û - lifecycleOwner –ù–ï –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –≤—ã–∑–æ–≤–µ
fun init(config: PhotoCaptureConfig, lifecycleOwner: androidx.lifecycle.LifecycleOwner) {
    if (this::config.isInitialized) {
        return  // ‚ùå –†–∞–Ω–Ω–∏–π –≤—ã—Ö–æ–¥ –ë–ï–ó –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è lifecycleOwner!
    }
    this.lifecycleOwner = lifecycleOwner
    // ...
}
```

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–∞–≥–∞:**
1. Fragment –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è ‚Üí `viewModel.init(config, viewLifecycleOwner)` ‚Üí lifecycleOwner —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
2. Fragment ‚Üí –ì–∞–ª–µ—Ä–µ—è ‚Üí `onPause()` ‚Üí –∫–∞–º–µ—Ä–∞ –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç—Å—è
3. –ì–∞–ª–µ—Ä–µ—è ‚Üí Fragment (–≤–æ–∑–≤—Ä–∞—Ç) ‚Üí **Fragment –ü–ï–†–ï–°–û–ó–î–ê–Å–¢–°–Ø —Å –ù–û–í–´–ú viewLifecycleOwner**
4. `viewModel.init(config, viewLifecycleOwner)` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–Ω–æ–≤–∞
5. –ù–û init() –¥–µ–ª–∞–µ—Ç —Ä–∞–Ω–Ω–∏–π return ‚Üí **–°–¢–ê–†–´–ô lifecycleOwner –æ—Å—Ç–∞—ë—Ç—Å—è!**
6. `initialize()` ‚Üí `initializeCamera(–°–¢–ê–†–´–ô_lifecycleOwner)` ‚Üí –∫–∞–º–µ—Ä–∞ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –º—ë—Ä—Ç–≤–æ–º—É lifecycle
7. CameraX –Ω–µ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–º–µ—Ä—É ‚Üí **"not bound to a valid camera"**

### –†–µ—à–µ–Ω–∏–µ v3

**–í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º lifecycleOwner** –≤ `PhotoCaptureViewModel.init()`:

```kotlin
// ‚úÖ –°–¢–ê–õ–û - lifecycleOwner –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ
fun init(config: PhotoCaptureConfig, lifecycleOwner: androidx.lifecycle.LifecycleOwner) {
    Log.d("PhotoCaptureVM", "init() –≤—ã–∑–≤–∞–Ω. config –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: ${this::config.isInitialized}")

    // –ö–†–ò–¢–ò–ß–ù–û: –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º lifecycleOwner!
    // Fragment –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –∏ viewLifecycleOwner –º–µ–Ω—è–µ—Ç—Å—è
    this.lifecycleOwner = lifecycleOwner

    if (this::config.isInitialized) {
        // Config —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ lifecycleOwner –æ–±–Ω–æ–≤–ª—ë–Ω
        Log.d("PhotoCaptureVM", "Config —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, lifecycleOwner –æ–±–Ω–æ–≤–ª—ë–Ω")
        return
    }

    this.config = config
    // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ `lifecycleOwner` –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è **–î–û –ø—Ä–æ–≤–µ—Ä–∫–∏** config.isInitialized
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–π lifecycleOwner –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ init()
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–æ–±–ª–µ–º–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞** (v3)! ‚úÖ

### –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è:

- ‚úÖ –ö–∞–º–µ—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–∫–∏ "not bound to a valid camera"
- ‚úÖ –ù–µ—Ç —á—ë—Ä–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
- ‚úÖ **lifecycleOwner –≤—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**
- ‚úÖ –£—Å—Ç—Ä–∞–Ω—ë–Ω race condition –ø—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π cleanup –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –ø–æ–¥–ø–∏—Å–∫–∏)
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö

**–ö–∞–º–µ—Ä–∞ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø—Ä–∏ –ª—é–±—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏!** üé•üì∏‚ú®
